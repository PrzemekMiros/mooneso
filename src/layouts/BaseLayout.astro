---
import settings from "../content/ustawienia.json";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import PageHero from "./heroes/PageHero.astro";
import "../styles/global.css";
import { getImage } from "astro:assets";
import ogImage from "../assets/images/opengraph/opengraph.png";
import faviconSvg from "../assets/images/global/favicon.svg";
import faviconPng from "../assets/images/global/favicon.png";
import haigrast from "../assets/fonts/Haigrast/Haigrast.otf?url";
import saonara from "../assets/fonts/Saonara/saonara.otf?url";
import latoRegular from "../assets/fonts/Lato/Lato-Regular.ttf?url";

const assets = import.meta.glob("/src/assets/**/*", { eager: true });
const resolveAsset = (path) => {
  if (!path) return null;
  const entry = assets[`/src${path}`];
  return entry?.default ?? null;
};

const { title, description, showHero = true, robots, heroMeta } = Astro.props;
const { site, url } = Astro;
const pageTitle = title ? ` ${title} - ${settings.siteTitle}` : settings.siteTitle;
const metaDescription = description ?? settings.metaDescription;
const logoAsset = resolveAsset(settings.logo);
const processedOgImage = await getImage({ src: ogImage, format: 'png' });
const ogImageUrl = site ? new URL(processedOgImage.src, site).toString() : processedOgImage.src;
---

<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <link
      rel="preload"
      as="font"
      type="font/otf"
      href={haigrast}
      crossorigin
    />
    <link
      rel="preload"
      as="font"
      type="font/otf"
      href={saonara}
      crossorigin
    />
    <link
      rel="preload"
      as="font"
      type="font/ttf"
      href={latoRegular}
      crossorigin
    />
    <link rel="icon" type="image/svg+xml" href={faviconSvg.src} />
    <link rel="icon" type="image/png" href={faviconPng.src} />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta name="robots" content={robots === 'noindex' ? 'noindex' : 'index'} />
    
    <title>{pageTitle}</title>
    <meta name="description" content={metaDescription} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:image" content={ogImageUrl} />
    {site ? <meta property="og:url" content={new URL(url.pathname, site).toString()} /> : null}
    {site ? <link rel="canonical" href={new URL(url.pathname, site).toString()} /> : null}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImageUrl} />

    <style is:inline>
      /* swup.js page transition */
      .swup-transition {
        opacity: 1;
        transform: none;
        transition: opacity 220ms ease, transform 220ms ease;
      }
      html.is-changing .swup-transition {
        opacity: 0;
        transform: translateY(-24px);
      }
      html.is-rendering .swup-transition {
        opacity: 0;
        transform: translateY(24px);
      }

      .site-intro {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: grid;
        place-items: center;
        background: #e5e4e0;
        color: #111111;
        opacity: 1;
        visibility: visible;
        transition: opacity 1s ease, visibility 1s ease;
      }

      .site-intro.is-hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      .site-intro__content {
        position: relative;
        z-index: 1;
        display: grid;
        gap: 0;
        justify-items: center;
        text-align: center;
        padding: 0 1.5rem;
      }

    .site-intro__logo {
        display: block;
        white-space: nowrap;
        font-family: var(--font-heading);
        font-size: clamp(2rem, 6vw, 5.5rem);
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #111111;
        line-height: 0.95;
        opacity: 0;
        transform: translateY(90px);
        animation: intro-word-in 2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
      }

      @keyframes intro-word-in {
        0% {
          opacity: 0;
          transform: translateY(90px);
        }
        30% {
          opacity: 1;
          transform: translateY(0);
        }
        70% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-90px);
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .site-intro__word {
          animation: none !important;
          opacity: 1;
          transform: none;
        }
      }
    </style>
  </head>
  <body class="min-h-screen bg-[#E5E4E0] font-sans text-[var(--text)]">
    <div class="site-intro" data-site-intro aria-hidden="true">
      <div class="site-intro__content">
        <div class="site-intro__logo">
<svg width="1308" height="202" viewBox="0 0 1308 202" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M227.08 4.19979V2.79979H174.44L113.68 163.24L51.8 2.79979H2.48104e-05V4.19979H25.2V197.4H2.48104e-05V198.8H51.8V197.4H26.6V6.71979L99.68 198.8H101.64L174.72 5.59979V197.4H149.52V198.8H227.08V197.4H201.6V4.19979H227.08ZM324.124 -0.000205994C265.884 -0.000205994 226.964 47.3198 226.964 100.8C226.964 154 265.884 201.6 324.124 201.6C382.364 201.6 421.284 154 421.284 100.8C421.284 47.3198 382.364 -0.000205994 324.124 -0.000205994ZM324.124 200.2C269.244 200.2 255.524 141.12 255.524 100.8C255.524 60.1998 269.244 1.39979 324.124 1.39979C379.284 1.39979 393.004 60.1998 393.004 100.8C393.004 141.12 379.284 200.2 324.124 200.2ZM523.952 -0.000205994C465.712 -0.000205994 426.792 47.3198 426.792 100.8C426.792 154 465.712 201.6 523.952 201.6C582.192 201.6 621.112 154 621.112 100.8C621.112 47.3198 582.192 -0.000205994 523.952 -0.000205994ZM523.952 200.2C469.072 200.2 455.352 141.12 455.352 100.8C455.352 60.1998 469.072 1.39979 523.952 1.39979C579.112 1.39979 592.832 60.1998 592.832 100.8C592.832 141.12 579.112 200.2 523.952 200.2ZM755.766 2.79979V4.19979H780.686V157.08L670.366 2.79979H621.086V4.19979H640.966L646.286 11.7598V197.4H621.086V198.8H672.886V197.4H647.686V13.4398L779.286 200.76H782.086V4.19979H807.566V2.79979H755.766ZM956.821 138.6C955.141 170.52 940.021 197.4 907.541 197.4H856.861V96.0398H873.661C902.501 96.0398 912.301 111.16 913.701 135.8H915.101V54.5998H913.701C912.301 79.5198 902.501 94.6398 873.661 94.6398H856.861V4.19979H896.621C929.101 4.19979 943.661 23.5198 946.181 52.0798H947.581V2.79979H804.781V4.19979H829.981V197.4H804.781V198.8H958.221V138.6H956.821ZM1039.12 80.0798C999.082 64.6798 991.802 50.6798 991.802 35.2798C991.802 17.9198 1005.24 1.39979 1034.08 1.39979C1064.04 1.39979 1081.68 21.8398 1089.52 53.1998H1090.64V3.91979H1089.24C1087 8.6798 1085.32 11.4798 1078.04 11.4798C1067.12 11.4798 1058.44 -0.000205994 1034.08 -0.000205994C999.922 -0.000205994 973.042 21.2798 973.042 50.1198C973.042 78.3998 989.842 91.5598 1027.36 107.8C1060.96 122.64 1088.4 130.76 1088.4 158.2C1088.4 185.64 1068.8 200.2 1038.28 200.2C998.242 200.2 978.362 168.84 970.802 137.48H969.402V199.92H970.802C972.762 195.16 976.122 189.84 983.402 189.84C996.282 189.84 1015.04 201.6 1038.28 201.6C1082.52 201.6 1109.4 178.64 1109.4 145.6C1109.4 119.28 1096.8 102.76 1039.12 80.0798ZM1210.61 -0.000205994C1152.37 -0.000205994 1113.45 47.3198 1113.45 100.8C1113.45 154 1152.37 201.6 1210.61 201.6C1268.85 201.6 1307.77 154 1307.77 100.8C1307.77 47.3198 1268.85 -0.000205994 1210.61 -0.000205994ZM1210.61 200.2C1155.73 200.2 1142.01 141.12 1142.01 100.8C1142.01 60.1998 1155.73 1.39979 1210.61 1.39979C1265.77 1.39979 1279.49 60.1998 1279.49 100.8C1279.49 141.12 1265.77 200.2 1210.61 200.2Z" fill="black"/>
</svg>
        </div>
      </div>
    </div>
    <Header settings={settings} logoAsset={logoAsset} />
    <main 
      id="swup"
      class="swup-transition mx-auto flex min-h-screen w-full max-w-[1420px] bg-[#E5E4E0] flex-col px-4 sm:px-10 lg:px-12"
    >
      {showHero && title ? <PageHero title={title} lead={description} meta={heroMeta} /> : null}
      <slot class="relative bg-[#E5E4E0] z-10"/>
      <Footer/>
    </main>

    <script is:inline>
      (() => {
        const intro = document.querySelector("[data-site-intro]");
        if (!intro) return;

        const start = () => {
          if (intro.classList.contains("is-hidden")) return;
          intro.classList.add("is-active");

          const startedAt = performance.now();
          const minDuration = 1800;
          const hide = () => intro.classList.add("is-hidden");
          const scheduleHide = () => {
            const elapsed = performance.now() - startedAt;
            const remaining = Math.max(0, minDuration - elapsed);
            setTimeout(hide, remaining);
          };

          const skip = () => {
            hide();
          };

          intro.addEventListener("click", skip, { once: true });
          window.addEventListener("keydown", skip, { once: true });

          if (document.readyState === "complete") {
            scheduleHide();
          } else {
            window.addEventListener("load", scheduleHide, { once: true });
            setTimeout(scheduleHide, 7000);
          }
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", start, { once: true });
        } else {
          start();
        }
      })();
    </script>
    <script type="module" is:inline>
      import Swup from "https://unpkg.com/swup@4?module";
      const initSwup = () => {
        if (!window.__swup) {
          window.__swup = new Swup({
            containers: ["#swup"],
            animateHistoryBrowsing: true,
          });
        }
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initSwup, { once: true });
      } else {
        initSwup();
      }
    </script>
    <script is:inline>
      const applyBlurLazy = () => {
        document.querySelectorAll("main img").forEach((img) => {
          if (img.dataset.blurLazy === "true") return;
          img.dataset.blurLazy = "true";
          img.setAttribute("loading", "lazy");
          img.setAttribute("decoding", "async");
          img.classList.add("blur-sm", "transition-[filter]", "duration-500");
          const clearBlur = () => img.classList.remove("blur-sm");
          if (img.complete) {
            clearBlur();
          } else {
            img.addEventListener("load", clearBlur, { once: true });
            img.addEventListener("error", clearBlur, { once: true });
          }
        });
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", applyBlurLazy, { once: true });
      } else {
        applyBlurLazy();
      }
      ["swup:contentReplaced", "swup:page:view"].forEach((evt) =>
        document.addEventListener(evt, applyBlurLazy)
      );
    </script>
  </body>
</html>

